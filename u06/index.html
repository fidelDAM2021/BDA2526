
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../u05/">
      
      
        <link rel="next" href="../u07/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>MQTT. Conceptes bàsics. - Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../styles/taules.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduccio" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26" class="md-header__button md-logo" aria-label="Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26" data-md-component="logo">
      
  <img src="../img/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              MQTT. Conceptes bàsics.
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26" class="md-nav__button md-logo" aria-label="Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26" data-md-component="logo">
      
  <img src="../img/logo.svg" alt="logo">

    </a>
    Mòdul: Big Data Aplicat (CE IA i Big Data) Curs 25/26
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inici
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../documents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Presentació
  

    
      <br>
      <small>Mòdul Big Data Aplicat</small>
    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Introducció al Big Data
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Elements i arquitectura Big Data
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3.1 Repàs Docker
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u03/annex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3.2 Docker Compose
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.1 Introducció a Node-RED
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u04/nodered-intermedi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.2 Node-RED intermedi
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u04/nodered-avan%C3%A7at/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.3 Node-RED avançat
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u04/nodered-dashboards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.4 Node-RED dashboards
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u04/nodered-formularis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4.5 Formularis en Node-RED
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Fiware. Orion. Context Broker
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    6. MQTT
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    6. MQTT
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocols-de-comunicacio-iot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocols de comunicació IOT
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solucions-a-la-comunicacio-iot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solucions a la comunicació IoT
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metodologies-de-comunicacio-publishsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metodologies de comunicació: Publish/Subscribe
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metodologies de comunicació: Publish/Subscribe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cua-de-missatges-message-queue" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cua de missatges (message queue)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servei-de-missatgeria-message-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Servei de missatgeria (message service)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../u07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7.1 Stack ELK. Introducció
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#protocols-de-comunicacio-iot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Protocols de comunicació IOT
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solucions-a-la-comunicacio-iot" class="md-nav__link">
    <span class="md-ellipsis">
      
        Solucions a la comunicació IoT
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#metodologies-de-comunicacio-publishsubscribe" class="md-nav__link">
    <span class="md-ellipsis">
      
        Metodologies de comunicació: Publish/Subscribe
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Metodologies de comunicació: Publish/Subscribe">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cua-de-missatges-message-queue" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cua de missatges (message queue)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#servei-de-missatgeria-message-service" class="md-nav__link">
    <span class="md-ellipsis">
      
        Servei de missatgeria (message service)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="introduccio">Introducció</h1>
<p><strong>MQTT</strong> és un protocol de missatgeria lleugera que es va desenvolupar per a dispositius amb recursos limitats, com ara sensors. Aquest protocol és molt popular en el món de l'<strong>Internet of Things</strong> (IoT) perquè permet als dispositius enviar i rebre missatges de forma eficient i fiable. </p>
<p>El seu avantatge respecte a altres protocols similars és que és molt senzill i consumeix molt pocs recursos, cosa que el fa ideal per a dispositius amb poca potència de processament i poca memòria. A més, <strong>MQTT</strong> utilitza un model de comunicació <strong>Pub/Sub</strong> (Publicar/Suscribir), que permet una gran flexibilitat i escalabilitat en la comunicació entre dispositius.</p>
<p>No hem de confondre <strong>MQTT</strong>, que és un protocol de missatgeria, amb <strong>Orion</strong>, que és un broker de dades. <strong>MQTT</strong> és un protocol que defineix com es comuniquen els dispositius, mentre que <strong>Orion</strong> és una plataforma que pot utilitzar diferents protocols de comunicació, inclòs <strong>MQTT</strong>, per a gestionar i processar les dades dels dispositius.</p>
<p>A més, <strong>MQTT</strong> no sap res d'entitats ni del context, només envia i rep missatges per tòpics. És el broker, com per exemple <strong>Orion</strong>, el que s'encarrega de gestionar les entitats i el context associat a cada missatge.</p>
<p>Anem a veure primer alguns conceptes associats als protocols de comunicació / missatgeria.</p>
<h2 id="protocols-de-comunicacio-iot">Protocols de comunicació IOT</h2>
<p><strong>IoT</strong> (Internet of Things) és un concepte molt d'actualitat en els darrers anys. Fa referència a la interconnexió digital d'objectes quotidians amb Internet. Aquests objectes poden ser des de electrodomèstics fins a vehicles, passant per qualsevol tipus de sensor o dispositiu electrònic.</p>
<p>Els <strong>protocols de comunicació</strong> són els encarregats de definir com s'han de comunicar els dispositius. Un protocol de comunicació estableix les regles que han de seguir els dispositius per a comunicar-se entre ells i poder intercanviar informació.</p>
<p>Algunes característiques desitjables per a un protocol de comunicació són:</p>
<ul>
<li><strong>Eficiència</strong>: que siga ràpid, que permete gran quantitat de comunicacions simultànies i minimitze tant les dimensions dels missatges com el consum de recursos.</li>
<li><strong>Escalabilitat</strong>: que se puguen afegir o retirar dispositius sense que el comportament del sistema es veja afectat.</li>
<li><strong>Escasa dependència</strong>: que la dependència entre els dispositius siga la menor possible.</li>
<li><strong>Interoperabilitat</strong>: que siga compatible amb diferents dispositius i sistemes.</li>
<li><strong>Seguretat</strong>: hem de tindre en compte que tant els dispositius com les comunicacions entre ells funcionen a través de la xarxa i per tant poden ser vulnerables a atacs.</li>
<li><strong>Accés senzill als dispositius</strong>: ha de ser fàcil connectar-se als dispositius i controlar-los. S'han de preveure problemes amb adreces dinàmiques, DHCP, poc ample de banda, etc.</li>
</ul>
<p>Hi ha molts protocols de comunicació com per exemple un que ja coneixeu, <strong>HTTP</strong>. Un dels més populars en l'àmbit de l'IoT és <strong>MQTT</strong> (Message Queuing Telemetry Transport).</p>
<h2 id="solucions-a-la-comunicacio-iot">Solucions a la comunicació IoT</h2>
<p>Una possible solució als problemes que ens podem trobar al treballar en un entorn IoT és utilitzar un servei de notificacions centralitzat. Això ho hem vist, per exemple, al parlar de <strong>Brokers de dades</strong>, d'<strong>Orion</strong> i també de <strong>Kafka</strong>, però que pot ser també un element físic del sistema. Se tracta d'externalitzar la infraestructura més costosa, cosa que cada vegada és més comú en les empreses. </p>
<p><img alt="Centralització de la comunicació en un entorn IoT" src="images/u06-01.jpg" /></p>
<p>En este esquema un servidor central s'encarrega de rebre els missatges de tots els dispositius emisors i lliurar-los als receptors. El servidor té una adreça / domini conegut per tots els dispositius, que només se comuniquen amb ell. Així assegurem l'escalabilitat del sistema i la independència entre els dispositius.</p>
<h2 id="metodologies-de-comunicacio-publishsubscribe">Metodologies de comunicació: Publish/Subscribe</h2>
<p>El patró <strong>Publish/Subscribe</strong>, o <strong>Pub/Sub</strong>, se basa en l'esquema que acabem de veure: els diferents agents (<strong><em>emisors/publisher</em></strong> i <strong><em>receptors/subscriber</em></strong>) no es coneixen entre ells, sinó que es comuniquen a través d'un intermediari (broker). Els receptors informen al broker dels missatges que volen rebre i el broker s'encarrega de lliurar-los. Els emisors són els que publiquen els missatges que després el broker distribueix als receptors.</p>
<p>La forma en què se distribueixen els missatges pot ser de diferents maneres.</p>
<h3 id="cua-de-missatges-message-queue">Cua de missatges (message queue)</h3>
<p>El broker genera una cua de missatges única per cadascun dels clients (receptors/subscribers). Els missatges se discriminaran utilitzant l'identificador únic de cada client. La cua manté els missatges fins que són lliurats als clients. Això permet que els clients puguen rebre missatges encara que no estiguen connectats en el moment que es produeixen. Exemple d'este tipus de comunicació serien serveis com ara <strong>Telegram</strong> o <strong>WhatsApp</strong>. </p>
<p><img alt="Esquema de message queue" src="images/u06-02.jpg" /></p>
<h3 id="servei-de-missatgeria-message-service">Servei de missatgeria (message service)</h3>
<p>El broker distribueix directament als clients connectats. Els missatges se filtren per diferents criteris. Els missatges que s'han enviat mentre el client està desconnectat se perden. Un exemple seria un xat en temps real, on quan entrem a la sala no rebem els missatges que s'han enviat abans de connectar-nos.</p>
<p><img alt="Esquema de message service" src="images/u06-03.jpg" /></p>
<p><strong>MQTT</strong> és un exemple de protocol Pub/Sub que utilitza la metodologia <strong><em>message queue</em></strong>. Un altre protocol similar seria <strong>AMQP</strong> (Advanced Message Queuing Protocol), encara que no seria tan lleuger com MQTT i per tant s'utilitza menys en IoT i més en entorns empresarials.</p>
<h1 id="mqtt">MQTT</h1>
<p><strong>MQTT</strong> (Message Queuing Telemetry Transport) és, com hem comentat, un protocol de missatgeria lleugera que es va desenvolupar per a dispositius amb recursos limitats, com ara sensors. Funciona seguint el protocol M2M2 (Machine to Machine), que se basa en el model de comunicació <strong>Pub/Sub</strong> i en la pila TCP/IP. És de tipus <strong><em>Message Queue</em></strong>. <strong>MQTT</strong> va ser creat per IBM en 1999, i posteriorment (2010) se va alliberar i finalment s'ha convertit en un estàndar obert.</p>
<h2 id="com-funciona-mqtt">Com funciona MQTT</h2>
<p>Com hem vist, el funcionament de <strong>MQTT</strong> se basa en el patró <strong>Pub/Sub</strong> i en l'existència d'un broker central que rep, selecciona i distribueix els missatges. </p>
<p>Els missatges s'organitzen en <strong>tòpics</strong> disposats de forma jeràrquica. Un client envia missatges a certs tòpics, i uns altres se poden subscriure a aquests tòpics per a rebre els missatges. <strong>MQTT</strong> utilitza, per defecte, el port 1883. Si funciona sobre <strong>TLS</strong> (MQTTs amb claus de comunicació segura) utilitza el port 8883. </p>
<h3 id="topics">Tòpics</h3>
<p>Un <strong>tòpic</strong> és un filtre que utilitza <strong>MQTT</strong> per a distribuir els missatges. Cada tòpic s'identifica per una cadena UTF-8 amb una longitud màxima de 65536 caràcters. Els noms dels tòpics són <strong><em>case sensitive</em></strong>, que com ja sabeu vol dir que distingeix entre majúscules i minúscules. Per tant els tòpics <strong>casa</strong> i <strong>Casa</strong> serien diferents.</p>
<p>Els tòpics s'organitzen de forma jeràrquica, separats per barres inclinades (/). Per exemple, el tòpic <code>casa/sensor/temperatura</code> indica que el missatge es refereix a la temperatura d'un sensor d'una casa. Els tòpics poden tindre molts subtòpics, i cada subtòpic també pot dividir-se en altres subtòpics.</p>
<p><img alt="Jerarquia de tòpics en MQTT" src="images/u06-04.jpg" /></p>
<p>El broker accepta qualsevol tòpic. Si no existeix, se crea en eixe instant. Cada publicació s'envia a un tòpic, però els clients se poden subscriure a un o més tòpics (fins i tot si no exiteix el tòpic, en funció de com ho tenim configurat). Per a subscriure's a múltiples tòpics a la vegada s'utilitzen els comodins o <strong><em>wildcards</em></strong>. Hi ha dos opcions:</p>
<ul>
<li><strong>+</strong>: substitueix un nivell del tòpic. Per exemple, <code>casa/sensor/+/temperatura</code> permet subscriure's a qualsevol sensor de temperatura d'una casa. Un altre exemple: <code>casa/sala/+</code> permet subscriure's a qualsevol subtòpic dins de <code>casa/sala</code>, però no als subtòpics de nivell inferior, perquè <strong>+</strong> només substitueix un nivell.</li>
</ul>
<p><img alt="Subscripció a tòpics amb comodí +" src="images/u06-05.jpg" /></p>
<ul>
<li><strong>#</strong>: substitueix tots els nivells del tòpic. Per exemple, <code>casa/#</code> permet subscriure's a qualsevol tòpic de la casa, siga del nivell que siga. El símbol <strong>#</strong> només es pot utilitzar al final del tòpic.</li>
</ul>
<blockquote>
<p>Lògicament no se pot posar <strong>+</strong> al principi, perquè no tendria sentit. Si no sabem el tòpic inicial no es podem subscriure. En cas de posar <strong>#</strong> al principi ens subscriuriem a tots els tòpics, i això pot ser un problema de seguretat, ineficència i rendiment.</p>
</blockquote>
<p><img alt="Subscripció a tòpics amb comodí #" src="images/u06-06.jpg" /></p>
<h2 id="mqtt-i-qos">MQTT i QoS</h2>
<p><strong>MQTT</strong> permet especificar el nivell de qualitat de servei (<strong>QoS</strong>) que es vol per a cada missatge. Això permet adaptar la comunicació a les necessitats de cada aplicació i gestionar la tolerància a errors.</p>
<p>Hi ha tres nivells de QoS:</p>
<ul>
<li><strong>QoS 0</strong>: <strong>At most once</strong>. El missatge es lliura com a molt una vegada. No es garanteix que el missatge arribe al receptor, en cas d'errades. És el més ràpid i menys fiable.</li>
<li><strong>QoS 1</strong>: <strong>At least once</strong>. El missatge es lliura com a mínim una vegada. Es garanteix que el missatge arribe al receptor, però pot arribar més d'una vegada amb la qual cosa certs missatges estaran duplicats. És més lent i més fiable que QoS 0.</li>
<li><strong>QoS 2</strong>: <strong>Exactly once</strong>. El missatge es lliura exactament una vegada. És el més lent però també el més fiable.</li>
</ul>
<h2 id="seguretat">Seguretat</h2>
<p>Per a garantir la seguretat de les comunicacions, <strong>MQTT</strong> disposa de:</p>
<ul>
<li>Transport SSL/TLS (MQTTs) per a xifrar les comunicacions.</li>
<li>Autenticació per usuari i contrasenya, o amb certificat. </li>
</ul>
<h2 id="avantatges-de-mqtt">Avantatges de MQTT</h2>
<p>Com hem vist abans, els protocols que utilitzen el patró <strong>Pub/Sub</strong> tenen avantatges comuns:</p>
<ul>
<li><strong>Escalabilitat</strong>: es poden afegir o retirar clients sense afectar el sistema.</li>
<li><strong>Asincronia</strong>: els clients (l'emisor i el receptor) no han d'estar connectats al mateix temps.</li>
<li><strong>Desacoblament</strong>: els clients no es coneixen entre ells.</li>
</ul>
<p>Altres avantatges de <strong>MQTT</strong>:</p>
<ul>
<li>És senzill i lleuger, fàcil d'implementar i utilitzar.</li>
<li>Baix consum.</li>
<li>No necessita un ample de banda elevat.</li>
</ul>
<h2 id="principals-brokers-mqtt-de-codi-obert">Principals brokers MQTT de codi obert</h2>
<p>Hi ha molts brokers MQTT de codi obert. Alguns dels més populars són:</p>
<ul>
<li><strong>Mosquitto</strong>: desenvolupat per la <strong>Eclipse Foundation</strong>. És un dels més populars i utilitzats. És lleuger i s'utilitza per a servidors de baixa potència.</li>
<li><strong>Mosca</strong>: desenvolupat per a <strong>Node.js</strong> en <strong>JavaScript</strong>. Se pot utilitzar com a mòdul de Node.js.</li>
<li><strong>Aedes</strong>: està escrit en Python i utilitza la biblioteca <strong>Asyncio</strong>.</li>
<li><strong>RabbitMQ</strong>: no és exactament MQTT sino que funciona més com un protocol de missatgeria <strong>AMQP</strong>.</li>
</ul>
<h2 id="exemple-dus-de-mqtt">Exemple d'ús de MQTT</h2>
<p>Per a veure un exemple d'ús de <strong>MQTT</strong> podem utilitzar el broker <strong>Mosquitto</strong>. Per a això, primer hem d'instal·lar-lo. En distribucions basades en Debian (com ara Ubuntu) es pot fer amb la comanda:</p>
<pre><code class="language-bash">sudo apt-get install mosquitto
</code></pre>
<p>Un cop instal·lat, podem iniciar el broker amb la comanda:</p>
<pre><code class="language-bash">sudo systemctl start mosquitto
</code></pre>
<p>A continuació, podem utilitzar el client de línia de comandes <strong>mosquitto_pub</strong> per a publicar missatges i <strong>mosquitto_sub</strong> per a subscriure'ns a tòpics i rebre missatges. Per exemple, per a publicar un missatge al tòpic <code>casa/sensor/temperatura</code>:</p>
<pre><code class="language-bash">mosquitto_pub -h localhost -t casa/sensor/temperatura -m &quot;25.5&quot;
</code></pre>
<p>I per a subscriure'ns al mateix tòpic i rebre els missatges:</p>
<pre><code class="language-bash">mosquitto_sub -h localhost -t casa/sensor/temperatura
</code></pre>
<p>Amb això, cada vegada que publiquem un missatge al tòpic <code>casa/sensor/temperatura</code>, el client subscrit rebrà el missatge i el mostrarà per pantalla.</p>
<p>Si no voleu o no podeu instal·lar el broker localment, ho feu en el contenidor que teniu penjat a Aules. A classe veurem el procés complet.</p>
<p>Lògicament, també podem treballar amb el protocol <strong>MQTT</strong> des de qualsevol llenguatge de programació, utilitzant les biblioteques adequades. Per exemple, en Python podem utilitzar la biblioteca <strong>paho-mqtt</strong> per a publicar i subscriure'ns a tòpics MQTT. En <strong>Node-RED</strong> també tenim nodes específics per a treballar amb MQTT, que ens permeten integrar fàcilment aquest protocol en els nostres fluxos de dades. Veurem exemples de tot això a classe.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>